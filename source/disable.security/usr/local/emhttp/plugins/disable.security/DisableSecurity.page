Menu="UserPreferences"
Title="Mitigation Settings"
Icon="bolt"
---
<?
foreach (glob("/sys/devices/system/cpu/vulnerabilities/*") as $vulnerability) {
	$mitigations .= "<tr><td>".basename($vulnerability)."</td><td>".exec("cat '$vulnerability'")."</td></tr>";
}

$pti = exec("cat /proc/cmdline | grep 'pti=off'");
$spectre = exec("cat /proc/cmdline | grep 'spectre_v2=off'");
$l1tf = exec("cat /proc/cmdline | grep 'l1tf=off'");
$mds = exec("cat /proc/cmdline | grep 'mds=off'");
$nospec_store = exec("cat /proc/cmdline | grep 'nospec_store_bypass_disable'");
$no_stf = exec("cat /proc/cmdline | grep 'no_stf_barrier'");
$all_mitigations = exec("cat /proc/cmdline | grep 'mitigations=off'");
$output = $pti | $spectre | $l1tf | $mds | $nospec_store | $no_stf | $all_mitigations;

$reboot = @file_get_contents("/tmp/disable.mitigations.reset");
if ($reboot) {
	$output = ($reboot == "disabled");
}
?>

<font size='5'><font color='orange'><i class='fa fa-warning'></i></font>&nbsp;&nbsp;Disabling Spectre, Meltdown and Zombieload (MDS) mitigations may improve your CPU speed.  But these are security risks for certain workloads, and disabling the mitigations is purely all at your own risk.</font>
<br><br><br>
<font size='3'>
<?
if ($reboot) 
	echo "<font color='orange'>Mitigations will be $reboot after a reboot</font>";
else {
	if ($output)
		echo "<font color='orange'>Mitigation(s) currently disabled</font>";
	else
		echo "<font color='green'>Mitigation(s) currently enabled</font>";
}
?>
<br><br>
Status:</font>
<?if ($reboot):?>
(will be updated after rebooting the server)
<?endif;?>
<br><br>
<table><?=$mitigations?></table>

<?if ($output):?>
<input type='button' onclick='$(this).hide();enableMitigations();' value='Enable Mitigations'>
<?else:?>
<input type='button' onclick='$(this).hide();disableMitigations();' value='Disable Mitigations'>
<?endif;?>
<script>
$(function() {
	if ( typeof caPluginUpdateCheck === "function" ) {
		caPluginUpdateCheck("disable.security.plg",{name:"Disable Security Mitigations"});
	}
});

function enableMitigations() {
	$.post("/plugins/disable.security/scripts/enableMitigations.php",{},function(data) {
		if (data) {
			location.reload();
		}
	});
}
function disableMitigations() {
	$.post("/plugins/disable.security/scripts/disableMitigations.php",{},function(data) {
		if (data) {
			location.reload();
		}
	});
}
</script>
<?
if ($reboot):
?>
<style>
.reboot_notice{position:fixed;top:1px;left:0;}
.reboot_notice{padding-right:20px;width:100%;height:40px;line-height:40px;color:#e68a00;background:#feefb3;border-bottom:#e68a00 1px solid;text-align:center;font-size:1.4rem;z-index:900;}
</style>
<script>
$(".upgrade_notice").after("<div class='reboot_notice'>You must reboot for the changes to take effect</div>");
$(".reboot_notice").show();
</script>
<?
endif;
?>