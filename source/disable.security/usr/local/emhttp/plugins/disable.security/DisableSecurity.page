Menu="UNRAID-OS"
Title="Mitigation Settings"
Icon="warning"
---
<?
foreach (glob("/sys/devices/system/cpu/vulnerabilities/*") as $vulnerability) {
	$mitigations .= "<tr><td>".basename($vulnerability)."</td><td>".exec("cat '$vulnerability'")."</td></tr>";
}

$pti = exec("cat /boot/syslinux/syslinux.cfg | grep 'pti=off'");
$spectre = exec("cat /boot/syslinux/syslinux.cfg | grep 'spectre_v2=off'");
$l1tf = exec("cat /boot/syslinux/syslinux.cfg | grep 'l1tf=off'");
$mds = exec("cat /boot/syslinux/syslinux.cfg | grep 'mds=off'");
$nospec_store = exec("cat /boot/syslinux/syslinux.cfg | grep 'nospec_store_bypass_disable'");
$no_stf = exec("cat /boot/syslinux/syslinux.cfg | grep 'no_stf_barrier'");
$output = $pti | $spectre | $l1tf | $mds | $nospec_store | $no_stf;
?>

<font size='5'>Disabling Spectre, Meltdown and Zombieland (MDS) mitigations may improve your CPU speed.  But these are security risks for certain workloads, and disabling the mitigations is purely all at your own risk.</font>
<br><br><br>
<font size='3'>
<?
if ($output) echo "<font color='red'>Mitigation(s) disabled</font>"; else echo "<font color='green'>Mitigation(s) enabled</font>";
?>
<br><br>
Status:</font><br><br>
<table><?=$mitigations?></table>
<?if ($output):?>
<input type='button' onclick='enableMitigations();' value='Enable Mitigations'>
<?else:?>
<input type='button' onclick='disableMitigations();' value='Disable Mitigations'>
<?endif;?>
<script>
$(function() {
	if ( typeof caPluginUpdateCheck === "function" ) {
		caPluginUpdateCheck("disable.security.plg",{name:"Disable Security Mitigations"});
	}
});

function enableMitigations() {
	$.post("/plugins/disable.security/scripts/enableMitigations.php",{},function(data) {
		if (data) {
			location.reload();
		}
	});
}
function disableMitigations() {
	$.post("/plugins/disable.security/scripts/disableMitigations.php",{},function(data) {
		if (data) {
			location.reload();
		}
	});
}
</script>
<?
if ( is_file("/tmp/disable.mitigations.reset") ):
?>
<style>
.reboot_notice{position:fixed;top:1px;left:0;}
.reboot_notice{padding-right:20px;width:100%;height:40px;line-height:40px;color:#e68a00;background:#feefb3;border-bottom:#e68a00 1px solid;text-align:center;font-size:1.4rem;z-index:900;}
</style>
<script>
$(".upgrade_notice").after("<div class='reboot_notice'>You must reboot for the changes to take effect</div>");
$(".reboot_notice").show();
</script>
<?
endif;
?>